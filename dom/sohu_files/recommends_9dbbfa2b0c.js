kola("newt.app.recommends.EachotherFollows",["jquery.Core"],function(a){function b(c){a.extend(this,c);a(function(){kola("newt.service.Recommends",function(d){d.getOtherRecommends({params:{uid:window.LOOKEDUSER.id,page:1,pageSize:6},success:function(e){a.extend(e,{followUserName:window.LOOKEDUSER.name});kola("mvc.view.TemplateEngine",function(f){f.getTemplate({name:"template.main.app.eachother_follows",complete:function(g){a("div.relat:first").hide().html(g.render({data:e})).addClass("t-friend").fadeIn("500");kola("newt.left.Follow",function(h){h.init({triggerMeta:"following-ftrigger"})})}})})}})})})}return b});kola("newt.app.recommends.EachotherFollowsWidget",["jquery.Core","util.data.DataBuffer","newt.data.Synchronizer"],function(c,d,b){function a(f){var e=this;f=c.extend({pageSize:5,cacheSize:25},f);c.extend(this,f);c.extend(this,{target:c(f.target),firstGetData:true,widgetid:"efw_"+(++a.COUNT),dataBuffer:new d({bufferSize:e.cacheSize,filler:function(i,j,h){kola("newt.service.Recommends",function(k){k.getOtherRecommends({params:{uid:window.LOOKEDUSER.id,page:i,pageSize:j},beforeCall:function(){e.MORERECOMMENDS_LOCKED=true},complete:function(){e.MORERECOMMENDS_LOCKED=false},success:function(l){e.MORERECOMMENDS_LOCKED=false;if(h){h(l.data)}}})})}})});e.target.attr("data-widgetid",e.widgetid);c("[data-widgetid='"+e.widgetid+"'] div.js-user").live("mouseenter",function(){c(this).find("a.js-remove").show()}).live("mouseleave",function(){c(this).find("a.js-remove").hide()});var g=[];b.watch("follow_op_list",function(j){if(j){var k=j.dataSet;for(var h in k){if(k[h].value==true){g.push(h);var i=e.target.find("div.js-user-"+h).find("a.js-add-follow").addClass("fuc_dis").find("b:first").html("已关注")}}b.sync("usercard_status")}});b.watch("usercard_status",function(l){if(l=="hide"||!l){for(var j=g.length-1;j>=0;--j){var h=g.pop();var k=e.target.find("div.js-user-"+h);if(k.size()<=0||k.data("fadeoutting")==true){continue}k.data("fadeoutting",true);k.find("a.js-add-follow").addClass("fuc_dis").find("b:first").html("已关注");(function(m,i){setTimeout(function(){e.reFillPeople({uid:m,complete:function(){i.data("fadeoutting",false)}})},500)})(h,k)}}});e.target.bind("click",function(i){var h=c(i.target).closest("a");if(h.hasClass("js-next")){e.next()}if(h.hasClass("js-remove")){e.reFillPeople({uid:h.attr("data-userid")})}if(h.hasClass("js-add-follow")&&h.data("sending")!=true){kola("newt.service.Follows",function(j){var k=[h.parents("div.js-user").attr("data-userid")];j.follow({params:{uids:k},beforeCall:function(){h.data("sending",true)},success:function(l){if(l.status!=0){h.data("sending",false);kola("newt.dialog.Notice",function(){tw.notice.alert(l.statusText)})}},fail:function(){h.data("sending",false);kola("newt.dialog.Notice",function(){tw.notice.alert("平地惊雷一声响！服务器爆炸咯~请稍后再试亲~")})}})})}});c(function(){e.next()})}a.COUNT=0;a.prototype.next=function(f){var e=this;if(e.MORERECOMMENDS_LOCKED==true){return}kola("mvc.view.TemplateEngine",function(g){g.getTemplate({name:"template.main.app.recommends.eachother_follows_widget",complete:function(h){e.dataBuffer.getData({num:e.pageSize,complete:function(j){if(j.length<=0&&e.firstGetData){e.target.remove();return}e.firstGetData=false;var i=c(h.render({data:{userList:j,profileUserName:window.LOOKEDUSER.name,profileUserId:window.LOOKEDUSER.id,profileUserSex:window.LOOKEDUSER.sex==0?"她":"他"}}));e.target.html("").append(i);e.target.find("div.js-recommends-userlist").fadeIn(300)}})}})})};a.prototype.reFillPeople=function(f){f=c.extend({complete:function(){}},f);var e=this;kola("mvc.view.TemplateEngine",function(g){g.getTemplate({name:"template.main.app.recommends.eachother_follows_widget_avatar_content",complete:function(h){var i=e.target.find("div.js-user-"+f.uid);e.dataBuffer.getData({num:1,complete:function(j){if(j.length>0){j=j[0]}else{i.remove();f.complete();if(e.target.find("div.js-user").size()<=0){e.next()}return}i.html("");i.removeClass("js-user-"+f.uid).addClass("js-user-"+j.uid).attr("data-userid",j.uid);var k=c(h.render({data:j}));i.css("display","none").append(k).fadeIn(300,function(){f.complete()})}})}})})};return a});kola("newt.app.recommends.HotRecommends",["jquery.Core","util.data.DataBuffer","newt.data.Synchronizer"],function(d,e,c){var a={"娱乐":"yule","热点":"hot","搞笑":"funny","美图":"photo",ALL:"_all"};function b(g){var f=this;g=d.extend({eachPageSize:3,eachCacheSize:12},g);d.extend(this,g);d.extend(this,{lockers:{},target:d(g.target),firstGetData:true,widgetid:"hr_"+(++b.COUNT),dataBuffers:{"娱乐":new e({bufferSize:f.eachCacheSize,filler:function(j,k,i){f.filler("娱乐",j,k,i)}}),"热点":new e({bufferSize:f.eachCacheSize,filler:function(j,k,i){f.filler("热点",j,k,i)}}),"搞笑":new e({bufferSize:f.eachCacheSize,filler:function(j,k,i){f.filler("搞笑",j,k,i)}}),"美图":new e({bufferSize:f.eachCacheSize,filler:function(j,k,i){f.filler("美图",j,k,i)}})}});f.target.attr("data-widgetid",f.widgetid);d("[data-widgetid='"+f.widgetid+"'] div.js-user").live("mouseenter",function(){d(this).find("a.js-del").show()}).live("mouseleave",function(){d(this).find("a.js-del").hide()});var h=[];c.watch("follow_op_list",function(k){if(k){var l=k.dataSet;for(var i in l){if(l[i].value==true){h.push(i);var j=f.target.find("div.js-user-"+i).find("a.js-add-follow").addClass("fuc_dis").find("b:first").html("已关注")}}c.sync("usercard_status")}});c.watch("usercard_status",function(m){if(m=="hide"||!m){for(var k=h.length-1;k>=0;--k){var j=h.pop();var l=f.target.find("div.js-user-"+j);if(l.size()<=0||l.data("fadeoutting")==true){continue}l.data("fadeoutting",true);l.find("a.js-add-follow").addClass("fuc_dis").find("b:first").html("已关注");(function(n,i){setTimeout(function(){f.reFillPeople({uid:n,complete:function(){i.data("fadeoutting",false)}})},500)})(j,l)}}});f.target.bind("click",function(j){var i=d(j.target).closest("a");if(i.hasClass("js-next")){f.next()}if(i.hasClass("js-del")){f.reFillPeople({uid:i.attr("data-userid")})}if(i.hasClass("js-add-follow")&&i.data("sending")!=true){kola("newt.service.Follows",function(k){var l=[i.parents("div.js-user").attr("data-userid")];k.follow({params:{uids:l},beforeCall:function(){i.data("sending",true)},success:function(m){if(m.status!=0){i.data("sending",false);kola("newt.dialog.Notice",function(){tw.notice.alert(m.statusText)})}},fail:function(){i.data("sending",false);kola("newt.dialog.Notice",function(){tw.notice.alert("平地惊雷一声响！服务器爆炸咯~请稍后再试亲~")})}})})}});kola("newt.service.Recommends",function(k){var j=[];for(var i in f.dataBuffers){j.push(a[i]+",1,"+f.eachCacheSize)}k.getHotRecommends({params:{cons:j.join("|")},beforeCall:function(){for(var l in f.dataBuffers){f.lockers[l]=true}},complete:function(){for(var l in f.dataBuffers){f.lockers[l]=false}},success:function(m){for(var l in f.dataBuffers){f.lockers[l]=false;f.dataBuffers[l].pushBuffer({data:m.data[a[l]]});++f.dataBuffers[l].page}f.next()},fail:function(){for(var l in f.dataBuffers){f.lockers[l]=false}}})})}b.COUNT=0;b.prototype.filler=function(h,i,j,f){var g=this;kola("newt.service.Recommends",function(k){k.getHotRecommends({params:{cons:a[h]+","+i+","+j},beforeCall:function(){g.lockers[h]=true},complete:function(){g.lockers[h]=false},success:function(l){g.lockers[h]=false;if(f){f(l.data)}},error:function(){g.lockers[h]=false;if(f){f([])}}})})};b.prototype.next=function(g){var f=this;for(var i in f.lockers){if(f.lockers[i]==true){return}}var h=0;for(var j in f.dataBuffers){++h}var k={widget:"complex",sublists:[]};for(var j in f.dataBuffers){f.dataBuffers[j].getData({num:f.eachPageSize,complete:(function(l){return function(m){if(m.length>0){k.sublists.push({type:l,data:{list:m,widget:"complex"}})}if(--h<=0){kola("mvc.view.TemplateEngine",function(n){n.getTemplate({name:"template.main.app.recommends.hot.face",complete:function(o){f.target.html(o.render({data:k}));f.target.find("div.js-sublist").fadeIn(300)}})})}}})(j)})}};b.prototype.reFillPeople=function(g){g=d.extend({complete:function(){}},g);var f=this;var i=f.target.find("div.js-user-"+g.uid);var j=i.parents("div.js-sublist:first");var h=j.attr("data-type");kola("mvc.view.TemplateEngine",function(k){k.getTemplate({name:"template.main.app.recommends.hot.avatarcontent",complete:function(l){f.dataBuffers[h].getData({num:1,complete:function(m){if(m.length>0){m=m[0]}else{i.remove();g.complete();if(j.find("div.js-user").size()<=0){f.target.find(".js-entrypart[data-type='"+h+"']").remove();j.remove()}if(f.target.find("div.js-sublist").size()<=0){f.next()}return}i.html("");i.removeClass("js-user-"+g.uid).addClass("js-user-"+m.id).attr("data-userid",m.id);var n=d(l.render({data:m}));i.css("display","none").append(n).fadeIn(300,function(){g.complete()})}})}})})};return b});