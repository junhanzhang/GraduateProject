kola("newt.avatar.AvatarDialog",["newt.avatar.SimpleWindow","newt.composer.ComboUploader","newt.util.Browser","newt.dialog.Notice"],function(b,c,d){function a(){var e=[].slice.call(arguments);return this.__init__.apply(this,e)}a.prototype={__init__:function(e){var h,g=$.extend({},e,this.getWinConfig(e));h=new b(g);if(d.isIE){this.overwriteClose(h)}this.eventHandlerScope=(g.eventHandlerScope&&g.eventHandlerScope!=this?g.eventHandlerScope:window);this.status=this.STATUS_NOT_SELECT;this.rotateUrl=g.rotateUrl||"/pic/proxy";var i=h.getWindowEl();var f=$(i).find('[data-mt="upload-img"]')[0];this.win=h;this.pic=f;this.zoom=1;this.min_zoom=1;this.proxy_pic=new Image();this.async_tasks={};this.cur_degree=0;this.pic_cache=[];h.open(g);this.bindEvent(g);this.readCallbackCfg(e)},close:function(e){this.win.close(false,false);this.onClose(e)},moveTo:function(){var e=[].slice.call(arguments);this.win.moveTo.apply(this.win,e)},onOpen:function(){this.initUploader()},onClose:function(g){if(g!=false){this.fireCallback("onClose")}if(!d.isIE&&this.uploader){try{this.uploader.reset();this.uploader.destroy()}catch(f){if(window.console&&console.error){console.error("AvatarDialog.onClose:: a error occured, info: "+f)}}}},onBeforeClose:function(){var g=this;var i=(this.status==this.STATUS_UPLOADING?"你确定要关闭吗？关闭后上传中图片将不会保存！":this.status==this.STATUS_UPLOAD_END?"你确定要关闭吗？关闭后编辑的头像将不会保存！":"");if(!i){return}var h=this.win.getWindowEl();var f=$(h).attr("style");if(d.isIE8){$(h).attr("style",f+"; z-index:8!important")}tw.notice.confirm({msg:i,subHandle:function(){var j=$(e).data("avatar_win");$(e).data("has_click_ok","true");j.close(false)},cancelHandle:function(){var k=$(e).data("css_text");var l=$(e).data("avatar_win");var m=$(e).data("avatar_dom");var j=$(e).data("has_click_ok")=="true";if(d.isIE8&&!j){$(m).attr("style",k)}$(e).removeData("css_text").removeData("avatar_win").removeData("avatar_dom").removeData("has_click_ok")}});var e=tw.window.getWindow("notice_confirm").getElement();e.data({avatar_win:this.win,avatar_dom:h,css_text:f});return false},doSave:function(){var i=this;var h=this.getPicSelection();var f=("act=icon&serviceid=31&uid="+UID+"&name="+encodeURIComponent(this.pic.src)+"&left="+h.left+"&top="+h.top+"&width="+h.width+"&height="+h.height+"&op=avt_180.png");var g=function(l){var k=/(\w)(_\w+\.\w+)$/;var j=l.replace(k,"m$2");i.showTip("success","保存成功!");if(d.isIE8){i.showTip("success","保存成功!")}i.status=i.STATUS_EDIT_SAVED;i.fireCallback("onIconSave",j)};var e=function(j){j=j.replace(/(\w)(_\w+\.\w+)$/,"s$2");i.doAjaxReq("/settings/icon/updateIcon","act=save_icon&icon="+j,function(){g(j)},function(){i.showTip("error","设置失败!")})};this.doAjaxReq("/pic/proxy",f,function(j){e(j.data)},function(j){i.showTip("error","设置失败!")})},showTip:function(f,h){var i,e;var g=((f=="error")?"showErrTip":"showTip");if(d.isIE8){i=$(this.win.getWindowEl());e=i.attr("style");i.attr("style",e+"; z-index:8!important");tw.notice[g](h,{onFadeOut:function(){if(i.css("zIndex")!=8){i.attr("style",e)}}})}else{tw.notice[g](h)}},onFileSelect:function(e){this.uploader.upload(e[0].id);this.win.switchContent("uploading");this.status=this.STATUS_UPLOADING;this.win.getButtonEl("select").removeClass(this.BTN_THEME_SELECT).addClass(this.BTN_THEME_RE_SELECT);this.win.setBtnShowState(true,"save");this.win.setBtnEnableState(false,"save")},onUploadSuccess:function(e,h){var g=(typeof h.data=="string"?h.data:h.data.middle);this.status=this.STATUS_UPLOAD_END;this.win.switchContent("uploadEnd");var i=this.win.getContentEl("uploadEnd");var f=i.find('[data-mt="upload-img"]');this.pic=f[0];this.cur_degree=0;this.pic_cache=[g];this.loadPic(g)},loadPic:function(e){this.proxy_pic.src=e},onPicLoad:function(g,f,e){$(this.pic).attr({src:g,"data-w":f,"data-h":e});this.doAsyncTask("onPicLoad");this.win.setBtnEnableState(true,"save select");this.uploader.setEnableSelect(true);this.updateZoom();this.updatePicSize();this.centerPic();this.updateZoomBtnState()},updateZoom:function(){var m=this.pic;var l=this.win.getContentEl("uploadEnd");var j=$(m).attr("data-w");var e=$(m).attr("data-h");var o=l.find(".imgallmask")[0];var h=o.offsetWidth;var n=o.offsetHeight;var k,g,f;g=(function(){for(k=1;k>=0.1;k-=0.1){if(j*k<=h||e*k<=n){return Number(k.toFixed(1))}}return 0.1})();f=this.min_zoom!=g;if(f){this.zoom=1;this.min_zoom=g}},onDragPic:function(r){if(r.button==2){return}var o=$(r.target)[0];var k=this.pic;var f=this.zoom;var x=Math.floor($(k).attr("data-h")*f);var l=Math.floor($(k).attr("data-w")*f);var h=k.getBoundingClientRect();var q=o.getBoundingClientRect();var j,w,u,m,t,s,i,g;j=r.clientX;m=r.clientY;i=parseInt(k.style.left,10)||0;g=parseInt(k.style.top,10)||0;if(l<=q.right-q.left){w=u=j}else{w=j-Math.abs(q.right-h.right);u=j+Math.abs(q.left-h.left)}if(x<=q.bottom-q.top){t=s=m}else{t=m-Math.abs(q.bottom-h.bottom);s=m+Math.abs(q.top-h.top)}var n=function(y){return false};var v=function(B){var D=B.clientX;var C=B.clientY;var y=k.style;var A=(D<=w?i+(w-j):D>=u?i+(u-j):i+(D-j));var z=(C<=t?g+(t-m):C>=s?g+(s-m):g+(C-m));y.left=A+"px";y.top=z+"px";B.preventDefault()};var p=function(){$(document).unbind("mouseup",p).unbind("dragstart",n).unbind("mousemove",v)};$(document).bind({mouseup:p,mousemove:v,dragstart:n})},onUploadError:function(){var e=this.win;this.status=this.STATUS_UPLOAD_ERR;e.switchContent("uploadErr");e.setBtnShowState(true,"save");e.setBtnEnableState(false,"save")},doRotatePic:function(i){var k=this;var j=this.pic.src;if(!j){return}var f=this.win.getContentEl();var h=$(f).find(".pAvtCon");var m=$(h).find('[data-mt="preview"] :not([data-mt])');var e=$(h).find('[data-mt="load-tip"]');var q=$(h).find('[data-mt="oper-panel"] [data-mt]');var l=$(h).find('[data-mt="pic-ctn"]');var g=function(){h.addClass("pAvtLding");m.addClass("nodis");q.addClass("btn_dis");e.fadeIn();l.css({opacity:"0.7"})};var p=function(){h.removeClass("pAvtLding pAvtErr");m.removeClass("nodis");q.removeClass("btn_dis");e.html("");l.css("opacity",1);if(d.isIE6||d.isIE7){l.find("img").css("opacity",1)}};var n=function(r){p();k.onPicRotate(r)};var o=function(){var r='<p><i class="i"></i>旋转图片操作失败!</p>';h.removeClass("pAvtLding").addClass("pAvtErr");e.html(r).fadeOut(800,function(){p();k.uploader.setEnableSelect(true);k.win.setBtnEnableState(true,"save select")})};g();this.uploader.setEnableSelect(false);this.win.setBtnEnableState(false,"save select");this.getRotatePic(j,i,n,o)},getRotatePic:function(i,f,p,l){var k=this;var m=this.rotateUrl;var j=this.cur_degree;var h=f=="left"?-1:1;var e=(j+h>=0?(j+h)%4:3);var n=function(r){var q=(typeof r.data=="string"?r.data:r.data.middle);k.cur_degree=e;k.pic_cache[e]=q;p(q)};var o=this.pic_cache[e];if(o){n({data:o});return}var g=("serviceid=31&act=rotate&name="+encodeURIComponent(i)+"&uid="+UID+"&rdep="+(f=="left"?-90:90)+"&t="+new Date().getTime());this.doAjaxReq(m,g,n,l)},doChangeZoom:function(e){e=Number(e.toFixed(1));if(e>1||e<this.min_zoom||e==this.zoom){return}this.zoom=Number(e.toFixed(1));this.updateZoomBtnState();this.updatePicSize();this.centerPic()},onPicRotate:function(g){var e=this.pic;var f=e.offsetHeight;this.addAsyncTask("onPicLoad",function(){e.style.width=f+"px";e.style.height="auto"});this.loadPic(g)},addAsyncTask:function(e,g){var f=this.async_tasks[e];if(f==null){f=[];this.async_tasks[e]=f}f.push(g)},doAsyncTask:function(g){var j,k,f,h=this.async_tasks[g];if(!h||h.length==0){return}f=[].slice.call(arguments,1);while(k=h.shift()){if(typeof k=="function"){try{k.apply(this,f)}catch(l){}}}},onContentSwitch:function(g,f){if(g=="noSelect"){var e=this.win.getWindowEl();$(e).addClass("mwEA").removeClass("mwCA")}},updatePicSize:function(){var f=this.pic;var g=this.zoom;var e=$(f).attr("data-w");var i=$(f).attr("data-h");var h=Math.round(e*g);f.style.width=h+"px";f.style.height="auto"},centerPic:function(){var j=this.pic;var m=this.zoom;var f=$(this.win.getContentEl()).find(".preview")[0];var h=f.offsetHeight;var k=f.offsetWidth;var e=$(j).attr("data-h")*m;var i=$(j).attr("data-w")*m;var g=Math.floor((k-i)/2);var l=Math.floor((h-e)/2);$(j).css({left:g+"px",top:l+"px"})},updateZoomBtnState:function(){var g=this.zoom;var f=this.win.getContentEl("uploadEnd");var h=$('[data-mt="zoom-in"]',f);var e=$('[data-mt="zoom-out"]',f);if(g==this.min_zoom){$(e).addClass("btn_dis")}else{$(e).removeClass("btn_dis")}if(g==1){$(h).addClass("btn_dis")}else{$(h).removeClass("btn_dis")}},initUploader:function(){var h=this;var j=this.win;var g=j.getButtonEl("select");var e=CRTWCONFIG.UPURL;var f=[{el:g.find("b"),width:g.width(),height:g.height()}];var i=new c({MAX_SELECT_COUNT:1,preventCache:d.isIE,uploadUrl:e,postParams:{uid:UID,serviceid:31},handlerScope:this,createThumb:false,uploadAnchors:f,maxFileSize:10*1024*1024,fileFilter:"jpg, jpeg, png, gif, bmp, JPG, JPEG, GIF, BMP",onClick:this.onUploaderClick,onError:this.onUploadError,onSelect:this.onFileSelect,onSuccess:this.onUploadSuccess,onDialogOpen:function(){h.uploader.reset()}});this.uploader=i},bindEvent:function(e){var f=this;var i=this.win.getWindowEl();$(this.proxy_pic).bind({load:function(){f.onPicLoad(this.src,this.width,this.height)}});var g=$(i).find(".imgallmask");g.bind({mousedown:function(j){f.onDragPic(j)}});var h=function(k){var j=$(this).attr("data-mt");switch(j){case"rotate-left":f.doRotatePic("left");break;case"rotate-right":f.doRotatePic("right");break;case"zoom-in":f.doChangeZoom(f.zoom+0.1);break;case"zoom-out":f.doChangeZoom(f.zoom-0.1);break}};$("[data-mt]",i[0]).live({click:h})},doAjaxReq:function(e,h,g,f){$.ajax({url:e,type:"post",global:false,dataType:"json",data:h,success:function(i){if(i){if(i.status==0){g(i)}else{f()}}else{f()}},error:function(i){f()}})},getWinConfig:function(e){return{btns:this.getButtonsCfg(e),onOpen:this.onOpen,onClose:this.onClose,onBeforeClose:this.onBeforeClose,contents:this.getContentsCfg(e),onContentSwitch:this.onContentSwitch,eventHandlerScope:this}},getButtonsCfg:function(){return[{name:"save",btnClass:this.BTN_THEME_SAVE,isShow:false,onClick:this.doSave},{name:"select",btnClass:this.BTN_THEME_SELECT,isShow:true}]},getContentsCfg:function(f){var g=f&&f.data&&f.data.gender;var i=('<div class="hint '+(g=="female"?"hintFem":"")+'"><div class="hintT"><i class="i"></i><em></em></div></div>');var j=('<div class="pAvt"><div class="pAvtCon pAvtLding"><p class="ttl"></p><div class="preview"><div class="stat"></div></div><p class="oper"><a data-mt="zoom-in"  href="javascript:void(0);" class="fuc btn_dis"><i class="i iLg"></i><b>放大</b></a> |<a data-mt="zoom-out" href="javascript:void(0);" class="fuc btn_dis"><i class="i iRw"></i><b>缩小</b></a><a data-mt="rotate-left"  href="javascript:void(0);" class="fuc btn_dis"><i class="i iCw"></i><b>左旋</b></a> |<a data-mt="rotate-right" href="javascript:void(0);" class="fuc btn_dis"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');var e=('<div class="pAvt"><div class="pAvtCon"><p class="ttl">裁切头像图片</p><div data-mt="preview" class="preview" style="overflow: hidden;"><div data-mt="load-tip" class="stat"></div><div data-mt="pic-ctn"  style="position:relative; text-align:left; margin: 0 auto; width:252px; height:242px; overflow:hidden; zoom:1"><img data-mt="upload-img" src="" style="position:relative; display:block"/><div class="imgallmask" style="background:url(about:blank) ;left: 55px; top: 50px; width: 140px; height: 140px;" ><div class="imgareaselect-selection" style="width: 140px; height: 140px; left: 0px; top: 0px;"></div></div><div class="imggrey"><div class="imgareaselect-outer imgareaselect-outer1" style="width: 142px; height: 50px;"></div><div class="imgareaselect-outer imgareaselect-outer2" style="width: 142px; height: 50px;"></div><div class="imgareaselect-outer imgareaselect-outer3" style="width: 55px; height: 242px;"></div><div class="imgareaselect-outer imgareaselect-outer4" style="width: 55px; height: 242px;"></div></div></div></div><p data-mt="oper-panel" class="oper"><a data-mt="zoom-in"  href="javascript:void(0);" class="fuc"><i class="i iLg"></i><b>放大</b></a> |<a data-mt="zoom-out" href="javascript:void(0);" class="fuc"><i class="i iRw"></i><b>缩小</b></a><a data-mt="rotate-left"  href="javascript:void(0);" class="fuc"><i class="i iCw"></i><b>左旋</b></a> |<a data-mt="rotate-right" href="javascript:void(0);" class="fuc"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');var h=('<div class="pAvt"><div class="pAvtCon pAvtErr"><p class="ttl novis"></p><div class="preview"><div class="stat"><p><i class="i"></i><span data-mt="error-info">上传图片失败，请重新上传</span></p></div></div><p class="oper novis"><a data-mt="zoom-in"  href="javascript:void(0);" class="fuc btn_dis"><i class="i iLg"></i><b>放大</b></a> |<a data-mt="zoom-out" href="javascript:void(0);" class="fuc btn_dis"><i class="i iRw"></i><b>缩小</b></a><a data-mt="rotate-left"  href="javascript:void(0);" class="fuc btn_dis"><i class="i iCw"></i><b>左旋</b></a> |<a data-mt="rotate-right" href="javascript:void(0);" class="fuc btn_dis"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');return[{name:"noSelect",isShow:true,dom:i},{name:"uploading",isShow:false,dom:j},{name:"uploadEnd",isShow:false,dom:e},{name:"uploadErr",isShow:false,dom:h}]},getPicSelection:function(){var n=this.pic;var u=this.zoom;var l=$(n).attr("data-w");var f=$(n).attr("data-h");var r=Math.floor(l*u);var m=Math.floor(f*u);var o=r/l;var k=n.getBoundingClientRect();var q=this.win.getContentEl("uploadEnd").find(".imgallmask")[0];var j=q.getBoundingClientRect();var s=(q.offsetHeight<=m?q.offsetHeight:m);var h=(q.offsetWidth<=r?q.offsetWidth:r);var g=Math.round(h/o);var t=Math.round(s/o);var e=Math.min(g,t);var i=(h<r?Math.round(Math.abs(j.left-k.left)/o):0);var p=(s<m?Math.round(Math.abs(j.top-k.top)/o):0);return{left:i,top:p,width:g,height:t}},readCallbackCfg:function(f){if(!f){return}var h,e,k,j,g=["onIconSave","onClose"];this.callbackMap={};for(h=0,e=g.length;h<e;h++){k=g[h];j=f[k];if(j instanceof Function){this.callbackMap[k]=j}}},overwriteClose:function(e){var g,f;g=$(e.getWindowEl());f=function(i){if(i!=false){var h=e.fireCallback("onBeforeClose");if(h==false){return}}e.fireCallback("onClose");e.hide(false,false)};e.close=f;g.find(".mwCt>.close").unbind("click").click(f)},fireCallback:function(g){var i=this.callbackMap[g];var f=[].slice.call(arguments,1);var h=this.eventHandlerScope;if(i instanceof Function){try{i.apply(h,f)}catch(j){}}},BTN_THEME_SAVE:"btnCA2",BTN_THEME_SELECT:"btnCA",BTN_THEME_RE_SELECT:"btnCA3",STATUS_NOT_SELECT:0,STATUS_UPLOADING:1,STATUS_UPLOAD_ERR:2,STATUS_UPLOAD_END:3,STATUS_EDIT_SAVED:4};return a});kola("newt.avatar.AvatarDialog2",["newt.avatar.SimpleWindow","newt.composer.ComboUploader","newt.util.Browser","newt.avatar.Imgareaselect","newt.dialog.Notice"],function(b,c,d){function a(){var e=[].slice.call(arguments);return this.init.apply(this,e)}a.prototype={init:function(e){var g,f=$.extend({},e,this.getWinConfig(e));g=new b(f);if(d.isIE){this.overwriteClose(g)}this.min_select_width=f.min_select_width||100;this.min_select_height=f.min_select_height||100;this.max_select_width=f.max_select_width||180;this.max_select_height=f.max_select_height||180;this.eventHandlerScope=(f.eventHandlerScope&&f.eventHandlerScope!=this?f.eventHandlerScope:window);this.isSelectAreaShow=false;this.status=this.STATUS_NOT_SELECT;this.rotateUrl=f.rotateUrl||"/pic/proxy";this.picSelect=null;this.pic=null;this.win=g;g.open(f);this.bindEvent(f);this.readCallbackCfg(e);return g},onOpen:function(){this.initUploader()},onClose:function(){this.fireCallback("onClose");if(!d.isIE&&this.uploader){try{this.uploader.reset();this.uploader.destroy()}catch(f){if(window.console&&console.error){console.error("AvatarDialog.onClose:: a error occured, info: "+f)}}}},onBeforeClose:function(){var g=this;var j=(this.status==this.STATUS_UPLOADING?"你确定要关闭吗？关闭后上传中图片将不会保存！":this.status==this.STATUS_UPLOAD_END?"你确定要关闭吗？关闭后编辑的头像将不会保存！":"");if(j){var i=this.win.getWindowEl();var f=$(i).attr("style");var e=function(){$(i).attr("data-hasClose","true");g.win.close(false)};var h=function(){var k=$(i).attr("data-hasClose")=="true";if(d.isIE8&&!k){$(i).attr("style",f)}};if(d.isIE8){$(i).attr("style",f+"; z-index:8!important")}tw.notice.confirm({msg:j,subHandle:e,cancelHandle:h});return false}},onSave:function(){var i=this;var h=this.getPicSelection();var f=("act=icon&serviceid=31&uid="+UID+"&name="+encodeURIComponent(this.pic.src)+"&left="+h.left+"&top="+h.top+"&width="+h.width+"&height="+h.height+"&op=avt_180.png");var g=function(l){var k=/(\w)(_\w+\.\w+)$/;var j=l.replace(k,"m$2");tw.notice.showTip("保存成功!");i.status=i.STATUS_EDIT_SAVED;i.fireCallback("onIconSave",j)};var e=function(j){j=j.replace(/(\w)(_\w+\.\w+)$/,"s$2");i.doAjaxReq("/settings/icon/updateIcon","act=save_icon&icon="+j,function(){g(j)},function(){tw.notice.showErrTip("设置失败!")})};this.doAjaxReq("/pic/proxy",f,function(j){e(j.data)},function(j){tw.notice.showErrTip("设置失败!")})},onFileSelect:function(e){this.uploader.upload(e[0].id);this.win.switchContent("uploading");this.status=this.STATUS_UPLOADING;this.win.getButtonEl("select").removeClass(this.BTN_THEME_SELECT).addClass(this.BTN_THEME_RE_SELECT);this.win.setBtnShowState(true,"save");this.win.setBtnEnableState(false,"save")},onUploadSuccess:function(e,h){var g=(typeof h.data=="string"?h.data:h.data.middle);this.status=this.STATUS_UPLOAD_END;var i=this.win.getContentEl("uploadEnd");var f=i.find('[data-mt="upload-img"]');this.pic=f[0];$(f).attr("src",g)},onPicLoad:function(){var e=this.pic;this.win.switchContent("uploadEnd");this.win.setBtnEnableState(true,"save select");this.uploader.setEnableSelect(true);this.updateSelectArea()},onUploadError:function(){var e=this.win;this.status=this.STATUS_UPLOAD_ERR;e.switchContent("uploadErr");e.setBtnShowState(true,"save");e.setBtnEnableState(false,"save")},doRotatePic:function(i){var l=this;var k=this.pic.src;var m=this.rotateUrl;if(!k||!m){return}var j=("serviceid=31&act=rotate&name="+encodeURIComponent(k)+"&uid="+UID+"&rdep="+(i=="left"?-90:90)+"&t="+new Date().getTime());var f=this.win.getContentEl();var h=$(f).find(".pAvtCon");var o=$(h).find('[data-mt="preview"] :not([data-mt])');var e=$(h).find('[data-mt="load-tip"]');var r=$(h).find('[data-mt="oper-panel"] [data-mt]');var n=$(h).find('[data-mt="pic-ctn"]');var g=function(){h.addClass("pAvtLding");o.addClass("nodis");r.addClass("btn_dis");e.fadeIn();n.css({opacity:"0.7",filter:"filter : alpha(opacity=70)\9"})};var q=function(){h.removeClass("pAvtLding pAvtErr");o.removeClass("nodis");r.removeClass("btn_dis");e.html("");n.css({opacity:"1",filter:"filter : alpha(opacity=100)\9"})};var p=function(){var s='<p><i class="i"></i>旋转图片操作失败!</p>';h.removeClass("pAvtLding").addClass("pAvtErr");e.html(s).fadeOut(800,function(){q();l.uploader.setEnableSelect(true);l.win.setBtnEnableState(true,"save select")})};g();this.uploader.setEnableSelect(false);this.win.setBtnEnableState(false,"save select");this.doAjaxReq(m,j,function(s){q();l.onPicRotate(s.data)},p)},onPicRotate:function(e){this.pic.src=(typeof e=="string"?e:e.middle)},onPicSelectAreaChange:function(n,q){var j=q.x1;var o=q.y1;var s=q.x2;var g=q.y2;var m=$(n).width();var i=$(n).height();var h=this.pic;if(!(j==0||o==0||s==m||g==i)){return}var l=10;var k=h.width;var f=h.height;var p=parseInt(h.style.marginLeft||0);var t=parseInt(h.style.marginTop||0);if(j==0&&-p>0){h.style.marginLeft=(-p>l?(p+l):0)+"px"}if(o==0&&-t>0){h.style.marginTop=(-t>l?(t+l):0)+"px"}if(s==m&&-p<k-m){var e=((-p+m+l)<k?(p-l):(m-k));h.style.marginLeft=e+"px"}if(g==i&&-t<f-i){h.style.marginTop=((-t+i+l)<f?(t-l):(i-f))+"px"}},onContentSwitch:function(g,f){if(g=="noSelect"){var e=this.win.getWindowEl();$(e).addClass("mwEA").removeClass("mwCA")}},updateSelectArea:function(){if(this.picSelect==null){this.initPicSelect()}var p=this.win.getContentEl();var n=p.find(".preview");var j=p.find('[data-mt="pic-ctn"]');var l=this.pic;var w=this.picSelect;var i,h,k,s,u,o,t,g,r,f,q,e,m=l.width,v=l.height;l.style.marginLeft=0;l.style.marginTop=0;j.hide();t=n.width();g=n.height();k=Math.min(m,t);s=Math.min(v,g);o=m>t?0:Math.floor((t-m)/2);u=v>g?0:Math.floor((g-v)/2);j.show().css({top:u+"px",width:k+"px",height:s+"px"});if(m>this.min_select_width||v>this.min_select_height){i=Math.min(this.min_select_width,this.min_select_height,m,v);h=Math.min(this.max_select_width,this.max_select_height,m,v);this.isSelectAreaShow=true;w.setOptions({show:true,minWidth:i,minHeight:i,maxWidth:h,maxHeight:h});r=Math.floor((k-i)/2);f=Math.floor((s-i)/2);q=r+i;e=f+i;w.setSelection(r,f,q,e);w.doUpdate()}else{this.isSelectAreaShow=false;w.cancelSelection();w.doUpdate()}},initUploader:function(){var h=this;var j=this.win;var g=j.getButtonEl("select");var e=CRTWCONFIG.UPURL;var f=[{el:g.find("b"),width:g.width(),height:g.height()}];var i=new c({MAX_SELECT_COUNT:1,uploadUrl:e,postParams:{uid:UID,serviceid:31},handlerScope:this,createThumb:false,uploadAnchors:f,maxFileSize:10*1024*1024,preventCache:(d.isIE?true:false),fileFilter:"jpg, jpeg, png, gif, bmp, JPG, JPEG, GIF, BMP",onClick:this.onUploaderClick,onError:this.onUploadError,onSelect:this.onFileSelect,onSuccess:this.onUploadSuccess,onDialogOpen:function(){h.uploader.reset()}});this.uploader=i},initPicSelect:function(){var g=this;var f=this.win.getContentEl("uploadEnd");var j=f.find(".preview");var h=j.find('[data-mt="pic-ctn"]');var e=function(){var k=[].slice.call(arguments);g.onPicSelectAreaChange.apply(g,k)};var i=$(h).imgAreaSelect({parent:j,handles:true,instance:true,persistent:true,aspectRatio:"1:1",onSelectChange:e,keys:{arrows:10,ctrl:1,shift:1}});this.picSelect=i},bindEvent:function(e){var f=this;var h=this.win.getWindowEl();$(h).find('[data-mt="upload-img"]').load(function(){f.onPicLoad()});var g=function(j){var i=$(this).attr("data-mt");switch(i){case"rotate-left":f.doRotatePic("left");break;case"rotate-right":f.doRotatePic("right");break}};$("[data-mt]",h[0]).live({click:g})},doAjaxReq:function(e,h,g,f){$.ajax({url:e,type:"post",global:false,dataType:"json",data:h,success:function(i){if(i){if(i.status==0){g(i)}else{f()}}else{f()}},error:function(i){f()}})},getWinConfig:function(e){return{btns:this.getButtonsCfg(e),onOpen:this.onOpen,onClose:this.onClose,onBeforeClose:this.onBeforeClose,contents:this.getContentsCfg(e),onContentSwitch:this.onContentSwitch,eventHandlerScope:this}},getButtonsCfg:function(){return[{name:"save",btnClass:this.BTN_THEME_SAVE,isShow:false,onClick:this.onSave},{name:"select",btnClass:this.BTN_THEME_SELECT,isShow:true}]},getContentsCfg:function(f){var g=f&&f.data&&f.data.gender;var i=('<div class="hint '+(g=="female"?"hintFem":"")+'"><div class="hintT"><i class="i"></i><em></em></div></div>');var j=('<div class="pAvt"><div class="pAvtCon pAvtLding"><p class="ttl"></p><div class="preview"><div class="stat"></div></div><p class="oper"><a id="left_rotate"  href="javascript:void(0);" class="fuc btn_dis"><i class="i iCw"></i><b>左旋</b></a> |<a id="right_rotate" href="javascript:void(0);" class="fuc btn_dis"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');var e=('<div class="pAvt"><div class="pAvtCon"><p class="ttl">裁切头像图片</p><div data-mt="preview" class="preview"><div data-mt="load-tip" class="stat"></div><div data-mt="pic-ctn"  style="position:relative; margin: 0 auto; width:253px; height:242px; overflow:hidden;"><img data-mt="upload-img" src=""/></div></div><p data-mt="oper-panel" class="oper"><a data-mt="rotate-left"  href="javascript:void(0);"  class="fuc"><i class="i iCw"></i><b>左旋</b></a> |<a data-mt="rotate-right" href="javascript:void(0);" class="fuc"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');var h=('<div class="pAvt"><div class="pAvtCon pAvtErr"><p class="ttl novis"></p><div class="preview"><div class="stat"><p><i class="i"></i><span data-mt="error-info">上传图片失败，请重新上传</span></p></div></div><p class="oper novis"><a href="javascript:void(0);" class="fuc"><i class="i iCw"></i><b>左旋</b></a> |<a href="javascript:void(0);" class="fuc"><i class="i iCcw"></i><b>右旋</b></a></p></div></div>');return[{name:"noSelect",isShow:true,dom:i},{name:"uploading",isShow:false,dom:j},{name:"uploadEnd",isShow:false,dom:e},{name:"uploadErr",isShow:false,dom:h}]},getPicSelection:function(){var e=this.pic;var i=this.picSelect;var h,g,f;if(this.isSelectAreaShow){f=i.getSelection();h=e.style.marginLeft?Math.abs(parseInt(e.style.marginLeft,10)):0;g=e.style.marginTop?Math.abs(parseInt(e.style.marginTop,10)):0;return{left:h+f.x1,top:g+f.y1,width:(f.x2-f.x1),height:(f.y2-f.y1)}}else{return{left:0,top:0,width:e.width,height:e.height}}},readCallbackCfg:function(f){if(!f){return}var h,e,k,j,g=["onIconSave","onClose"];this.callbackMap={};for(h=0,e=g.length;h<e;h++){k=g[h];j=f[k];if(j instanceof Function){this.callbackMap[k]=j}}},fireCallback:function(g){var i=this.callbackMap[g];var f=[].slice.call(arguments,1);var h=this.eventHandlerScope;if(i instanceof Function){try{i.apply(h,f)}catch(j){}}},overwriteClose:function(e){var g,f;g=$(e.getWindowEl());f=function(i){if(i!=false){var h=e.fireCallback("onBeforeClose");if(h==false){return}}e.fireCallback("onClose");e.hide(false,false)};e.close=f;g.find(".mwCt>.close").unbind("click").click(f)},BTN_THEME_SAVE:"btnCA2",BTN_THEME_SELECT:"btnCA",BTN_THEME_RE_SELECT:"btnCA3",STATUS_NOT_SELECT:0,STATUS_UPLOADING:1,STATUS_UPLOAD_ERR:2,STATUS_UPLOAD_END:3,STATUS_EDIT_SAVED:4};return a});kola("newt.avatar.Icon",["jquery.Core","newt.cr.crButton","newt.Config","newt.swf.SwfUpload","newt.swf.jquerySwfUpload","newt.avatar.Imgareaselect","newt.dialog.Common","newt.dialog.Notice","newt.tool.Url"],function(){var icon="";icon={left:0,top:0,width:100,height:100};var img_w=100,img_h=100;var imgAreaSelect;var icon_path="";function preview(img,selection){if(!selection.width||!selection.height){return}var scaleX=180/selection.width;var scaleY=180/selection.height;$("#preview img").css({width:Math.round(scaleX*parseInt($("#preview2 img").width()))+"px",height:Math.round(scaleY*parseInt($("#preview2 img").height()))+"px",marginLeft:-Math.round(scaleX*selection.x1)+"px",marginTop:-Math.round(scaleY*selection.y1)+"px"});icon={left:selection.x1,top:selection.y1,width:selection.width,height:selection.height}}function loadimg(src){var img=new Image();$(img).load(function(){$(this).hide().unbind();$("#preview2").removeClass("loading2").html("").append(this);$(this).fadeIn();img_w=$(this).width();img_h=$(this).height();var preview2img=$("#preview2 img");if(parseInt(img_w)>parseInt(img_h)){preview2img.attr("width",252);preview2img.attr("height",parseInt(252*img_h/img_w))}else{preview2img.attr("height",252);preview2img.attr("width",parseInt(252*img_w/img_h))}if(imgAreaSelect){imgAreaSelect.cancelSelection()}var view2img_w=preview2img.attr("width");var view2img_h=preview2img.attr("height");var size=view2img_w>view2img_h?view2img_h:view2img_w;size=size>100?100:size;imgAreaSelect=$("#preview2 img").imgAreaSelect({aspectRatio:"1:1",parent:$("#preview2"),handles:true,fadeSpeed:200,onSelectChange:preview,instance:true,x1:0,y1:0,x2:size,y2:size,persistent:true});var img2=new Image();$(img2).load(function(){$(this).hide().unbind();$("#preview").removeClass("loading2").html("").append(this);$(this).fadeIn();preview($("#preview img"),imgAreaSelect.getSelection())}).error(function(){}).attr("src",src)}).error(function(){}).attr("src",src)}var save=function(){var photo_w=$("#preview2 img").width();var photo_h=$("#preview2 img").height();var oldPhoto=(typeof PHOTOICON=="string")?PHOTOICON.replace(/.*\//gi,""):"avt_180.png";$.ajax({url:"/pic/proxy",global:false,type:"post",dataType:"json",data:"act=icon&serviceid=31&uid="+UID+"&name="+escape(icon_path)+"&left="+parseInt(icon.left*img_w/photo_w)+"&top="+parseInt(icon.top*img_h/photo_h)+"&width="+parseInt(icon.width*img_w/photo_w)+"&height="+parseInt(icon.height*img_h/photo_h)+"&op="+oldPhoto,success:function(json){var finalAvatarData=json;if(json){if(json.status==0){var param="act=save_icon&icon="+json.data;$.ajax({url:"/settings/icon/updateIcon",global:false,type:"post",dataType:"json",data:param,success:function(json){if(json){if(json.status==0){kola("app.exp.task.TA",function(TA){TA.q("uploadhead_weibo_upload")});$("#preview2").addClass("nodis");$("#upavt_container").addClass("nodis");$("#apb_container").addClass("nodis");$("#save_icon").getCrControl("crButton").setEnable();$("#save_icon").html("<b>保 存</b>");if(imgAreaSelect){imgAreaSelect.cancelSelection()}kola("newt.data.Synchronizer",function(Synchronizer){Synchronizer.save("new_avatar",finalAvatarData.data)});var pUrl=$.url.param("forwardUrl");if(pUrl){window.location=pUrl}else{common.showTip("保存成功！")}}else{tw.notice.alert(json.statusText)}}else{tw.notice.alert("设置失败, 请稍后重试!")}},error:function(error){tw.notice.alert("设置失败, 请稍后重试!")}})}else{tw.notice.alert(json.statusText)}}else{tw.notice.alert("设置失败, 请稍后重试!")}},error:function(error){tw.notice.alert("设置失败, 请稍后重试!")}})};var Icon=function(){$("#save_icon").crButton({loadingHTML:'<b><i class="i iloading"></i>保存中</b>',submitHandle:save,status:"on"});$("#left_rotate").click(function(){$.ajax({url:"/pic/proxy",global:false,type:"post",dataType:"json",data:"act=rotate&serviceid=31&uid="+UID+"&name="+escape(icon_path)+"&rdep=-90&callback=",success:function(data){icon_path=data.statusText;$("#preview").addClass("loading2").html("");$("#preview2").addClass("loading2").html("");imgAreaSelect.cancelSelection();loadimg(data.data)},error:function(error){}})});$("#right_rotate").click(function(){$.ajax({url:"/pic/proxy",global:false,type:"post",dataType:"json",data:"act=rotate&serviceid=31&uid="+UID+"&name="+escape(icon_path)+"&rdep=90&callback=",success:function(data){icon_path=data.statusText;$("#preview").addClass("loading2").html("");$("#preview2").addClass("loading2").html("");loadimg(data.data);imgAreaSelect.cancelSelection()},error:function(error){}})});$("#swfupload-control").swfupload({upload_url:CRTWCONFIG.UPURL,file_size_limit:"10240",file_types:"*.jpg;*.jpeg;*.png;*.gif;*.bmp;*.JPG;*.JPEG;*.PNG;*.GIF;*.BMP",file_types_description:"Image Files",file_upload_limit:"0",button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,flash_url:CRTWCONFIG.UPLOAD_SWF,button_image_url:CRTWCONFIG.I_SWF,button_width:220,button_height:26,button_placeholder:$("#button")[0],debug:false,post_params:{uid:UID,serviceid:"31"},file_post_name:"Filedata",custom_settings:{something:"here"}}).bind("fileQueued",function(event,file){$(this).swfupload("startUpload")}).bind("uploadStart",function(event,file){if(imgAreaSelect){imgAreaSelect.cancelSelection()}$("#preview").removeClass("nodis").html("").addClass("loading2");$("#preview2").removeClass("nodis").addClass("loading2").find("img").addClass("novis");$("#upavt_container").removeClass("nodis");$("#apb_container").removeClass("nodis")}).bind("uploadSuccess",function(event,file,serverData){var data=eval("("+serverData+")");icon_path=data.statusText;imgAreaSelect=null;loadimg(data.data)}).bind("uploadComplete",function(event,file){$(this).swfupload("startUpload")})};return Icon});kola("newt.avatar.Imgareaselect",["jquery.Core"],function(){var b=Math.abs,a=Math.max,d=Math.min,c=Math.round;function e(){return $("<div/>")}$.imgAreaSelect=function(p,R){var av=$(p),T,aq=e(),ae=e(),G=e().add(e()).add(e()).add(e()),X=e().add(e()).add(e()).add(e()),K=$([]),Q,m,n,ay,M,g,z,L,A=0,ac="absolute",P,O,Z,Y,U=10,H,S,J,x,az,v,ax,u={x1:0,y1:0,x2:0,y2:0,width:0,height:0},k,ap,al,af,ab,am,t;function F(h){return h+ay.left-L.left}function E(h){return h+ay.top-L.top}function D(h){return h-ay.left+L.left}function y(h){return h-ay.top+L.top}function aj(h){return h.pageX-L.left}function ah(h){return h.pageY-L.top}function C(h){var o=h||Z,i=h||Y;return{x1:c(u.x1*o),y1:c(u.y1*i),x2:c(u.x2*o),y2:c(u.y2*i),width:c(u.x2*o)-c(u.x1*o),height:c(u.y2*i)-c(u.y1*i)}}function ad(i,w,h,o,aA){var aC=aA||Z,aB=aA||Y;u={x1:c(i/aC),y1:c(w/aB),x2:c(h/aC),y2:c(o/aB)};u.width=(h=F(u.x2))-(i=F(u.x1));u.height=(o=F(u.y2))-(w=F(u.y1))}function an(){if(!av.width()){return}ay={left:c(av.offset().left),top:c(av.offset().top)};M=av.width();g=av.height();if($().jquery=="1.3.2"&&$.browser.safari&&ac=="fixed"){ay.top+=a(document.documentElement.scrollTop,$("body").scrollTop());ay.left+=a(document.documentElement.scrollLeft,$("body").scrollLeft())}L=$.inArray(z.css("position"),["absolute","relative"])+1?{left:c(z.offset().left)-z.scrollLeft(),top:c(z.offset().top)-z.scrollTop()}:ac=="fixed"?{left:$(document).scrollLeft(),top:$(document).scrollTop()}:{left:0,top:0};m=F(0);n=E(0)}function W(h){if(!J){return}aq.css({left:F(u.x1),top:E(u.y1)}).add(ae).width(ab=u.width).height(am=u.height);ae.add(G).add(K).css({left:0,top:0});G.width(a(ab-G.outerWidth()+G.innerWidth(),0)).height(a(am-G.outerHeight()+G.innerHeight(),0));$(X[0]).css({left:m,top:n,width:u.x1,height:g});$(X[1]).css({left:m+u.x1,top:n,width:ab,height:u.y1});$(X[2]).css({left:m+u.x2,top:n,width:M-u.x2,height:g});$(X[3]).css({left:m+u.x1,top:n+u.y2,width:ab,height:g-u.y2});ab-=K.outerWidth();am-=K.outerHeight();switch(K.length){case 8:$(K[4]).css({left:ab/2});$(K[5]).css({left:ab,top:am/2});$(K[6]).css({left:ab/2,top:am});$(K[7]).css({top:am/2});case 4:K.slice(1,3).css({left:ab});K.slice(2,4).css({top:am})}if(h!==false){if($.imgAreaSelect.keyPress!=ar){$(document).unbind($.imgAreaSelect.keyPress,$.imgAreaSelect.onKeyPress)}if(R.keys){$(document)[$.imgAreaSelect.keyPress]($.imgAreaSelect.onKeyPress=ar)}}if($.browser.msie&&G.outerWidth()-G.innerWidth()==2){G.css("margin",0);setTimeout(function(){G.css("margin","auto")},0)}}function s(h){an();W(h);x=F(u.x1);az=E(u.y1);v=F(u.x2);ax=E(u.y2)}function ag(h,i){R.fadeSpeed?h.fadeOut(R.fadeSpeed,i):h.hide()}function B(i){var h=D(aj(i))-u.x1,o=y(ah(i))-u.y1;if(!t){an();t=true;aq.one("mouseout",function(){t=false})}H="";if(R.resizable){if(o<=U){H="n"}else{if(o>=u.height-U){H="s"}}if(h<=U){H+="w"}else{if(h>=u.width-U){H+="e"}}}aq.css("cursor",H?H+"-resize":R.movable?"move":"");if(Q){Q.toggle()}}function ai(h){$(p).css("cursor","");if(R.autoHide||u.width*u.height==0){ag(aq.add(X),function(){$(this).hide()})}R.onSelectEnd(p,C());$(document).unbind("mousemove",aa);aq.mousemove(B)}function r(h){if(h.which!=1){return false}an();if(H){$(p).css("cursor",H+"-resize");x=F(u[/w/.test(H)?"x2":"x1"]);az=E(u[/n/.test(H)?"y2":"y1"]);$(document).mousemove(aa).one("mouseup",ai);aq.unbind("mousemove",B)}else{if(R.movable){P=m+u.x1-aj(h);O=n+u.y1-ah(h);aq.unbind("mousemove",B);$(document).mousemove(f).one("mouseup",function(){R.onSelectEnd(p,C());$(document).unbind("mousemove",f);aq.mousemove(B)})}else{av.mousedown(h)}}return false}function q(){v=a(m,d(m+M,x+b(ax-az)*S*(v>x||-1)));ax=c(a(n,d(n+g,az+b(v-x)/S*(ax>az||-1))));v=c(v)}function ak(){ax=a(n,d(n+g,az+b(v-x)/S*(ax>az||-1)));v=c(a(m,d(m+M,x+b(ax-az)*S*(v>x||-1))));ax=c(ax)}function au(){if(b(v-x)<R.minWidth){v=x-R.minWidth*(v<x||-1);if(v<m){x=m+R.minWidth}else{if(v>m+M){x=m+M-R.minWidth}}}if(b(ax-az)<R.minHeight){ax=az-R.minHeight*(ax<az||-1);if(ax<n){az=n+R.minHeight}else{if(ax>n+g){az=n+g-R.minHeight}}}v=a(m,d(v,m+M));ax=a(n,d(ax,n+g));if(S){if(b(v-x)/S>b(ax-az)){ak()}else{q()}}if(b(v-x)>R.maxWidth){v=x-R.maxWidth*(v<x||-1);if(S){ak()}}if(b(ax-az)>R.maxHeight){ax=az-R.maxHeight*(ax<az||-1);if(S){q()}}u={x1:D(d(x,v)),x2:D(a(x,v)),y1:y(d(az,ax)),y2:y(a(az,ax)),width:b(v-x),height:b(ax-az)};W();R.onSelectChange(p,C())}function aa(h){v=H==""||/w|e/.test(H)||S?aj(h):F(u.x2);ax=H==""||/n|s/.test(H)||S?ah(h):E(u.y2);au();return false}function N(h,i){v=(x=h)+u.width;ax=(az=i)+u.height;u=$.extend(u,{x1:D(x),y1:y(az),x2:D(v),y2:y(ax)});W();R.onSelectChange(p,C())}function f(h){x=a(m,d(P+aj(h),m+M-u.width));az=a(n,d(O+ah(h),n+g-u.height));N(x,az);h.preventDefault();return false}function aw(){an();v=x;ax=az;au();H="";if(X.is(":not(:visible)")){aq.add(X).hide().fadeIn(R.fadeSpeed||0)}J=true;$(document).unbind("mouseup",ao).mousemove(aa).one("mouseup",ai);aq.unbind("mousemove",B);R.onSelectStart(p,C())}function ao(){$(document).unbind("mousemove",aw);ag(aq.add(X));u={x1:D(x),y1:y(az),x2:D(x),y2:y(az),width:0,height:0};R.onSelectChange(p,C());R.onSelectEnd(p,C())}function l(h){if(h.which!=1||X.is(":animated")){return false}an();P=x=aj(h);O=az=ah(h);$(document).one("mousemove",aw).one("mouseup",ao);return false}function V(){s(false)}function at(){T=true;I(R=$.extend({classPrefix:"imgareaselect",movable:true,resizable:true,parent:"body",onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},R));aq.add(X).css({visibility:""});if(R.show){J=true;an();W();aq.add(X).hide().fadeIn(R.fadeSpeed||0)}setTimeout(function(){R.onInit(p,C())},0)}var ar=function(w){var h=R.keys,aA,o,i=w.keyCode||w.which;aA=!isNaN(h.alt)&&(w.altKey||w.originalEvent.altKey)?h.alt:!isNaN(h.ctrl)&&w.ctrlKey?h.ctrl:!isNaN(h.shift)&&w.shiftKey?h.shift:!isNaN(h.arrows)?h.arrows:10;if(h.arrows=="resize"||(h.shift=="resize"&&w.shiftKey)||(h.ctrl=="resize"&&w.ctrlKey)||(h.alt=="resize"&&(w.altKey||w.originalEvent.altKey))){switch(i){case 37:aA=-aA;case 39:o=a(x,v);x=d(x,v);v=a(o+aA,x);if(S){ak()}break;case 38:aA=-aA;case 40:o=a(az,ax);az=d(az,ax);ax=a(o+aA,az);if(S){q()}break;default:return}au()}else{x=d(x,v);az=d(az,ax);switch(i){case 37:N(a(x-aA,m),az);break;case 38:N(x,a(az-aA,n));break;case 39:N(x+d(aA,M-D(v)),az);break;case 40:N(x,az+d(aA,g-y(ax)));break;default:return}}return false};function j(h,i){for(option in i){if(R[option]!==undefined){h.css(i[option],R[option])}}}function I(h){if(h.parent){(z=$(h.parent)).append(aq.add(X))}R=$.extend(R,h);an();if(h.handles!=null){K.remove();K=$([]);al=h.handles?h.handles=="corners"?4:8:0;while(al--){K=K.add(e())}K.addClass(R.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:A+1||1});if(!(parseInt(K.css("width"))>0)){K.width(5).height(5)}if(af=R.borderWidth){K.css({borderWidth:af,borderStyle:"solid"})}j(K,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}Z=R.imageWidth/M||1;Y=R.imageHeight/g||1;if(h.x1!=null){ad(h.x1,h.y1,h.x2,h.y2);h.show=!h.hide}if(h.keys){R.keys=$.extend({shift:1,ctrl:"resize"},h.keys)}X.addClass(R.classPrefix+"-outer");ae.addClass(R.classPrefix+"-selection");for(al=0;al++<4;){$(G[al-1]).addClass(R.classPrefix+"-border"+al)}j(ae,{selectionColor:"background-color",selectionOpacity:"opacity"});j(G,{borderOpacity:"opacity",borderWidth:"border-width"});j(X,{outerColor:"background-color",outerOpacity:"opacity"});if(af=R.borderColor1){$(G[0]).css({borderStyle:"solid",borderColor:af})}if(af=R.borderColor2){$(G[1]).css({borderStyle:"dashed",borderColor:af})}aq.append(ae.add(G).add(K).add(Q));if($.browser.msie){if(af=X.css("filter").match(/opacity=([0-9]+)/)){X.css("opacity",af[1]/100)}if(af=G.css("filter").match(/opacity=([0-9]+)/)){G.css("opacity",af[1]/100)}}if(h.hide){ag(aq.add(X))}else{if(h.show&&T){J=true;aq.add(X).fadeIn(R.fadeSpeed||0);s()}}S=(ap=(R.aspectRatio||"").split(/:/))[0]/ap[1];if(R.disable||R.enable===false){aq.unbind("mousemove",B).unbind("mousedown",r);av.add(X).unbind("mousedown",l);$(window).unbind("resize",V);av.add(av.parents()).unbind("scroll",V)}else{if(R.enable||R.disable===false){if(R.resizable||R.movable){aq.mousemove(B).mousedown(r)}if(!R.persistent){av.add(X).mousedown(l)}$(window).resize(V);av.add(av.parents()).scroll(V)}}if(R.close){ao()}R.enable=R.disable=undefined}this.getOptions=function(){return R};this.setOptions=I;this.getSelection=C;this.setSelection=ad;this.cancelSelection=ao;this.startSelection=aw;this.doUpdate=s;k=av;while(k.length&&!k.is("body")){if(!isNaN(k.css("z-index"))&&k.css("z-index")>A){A=k.css("z-index")}if(k.css("position")=="fixed"){ac="absolute"}k=k.parent()}if(!isNaN(R.zIndex)){A=R.zIndex}if($.browser.msie){av.attr("unselectable","on")}$.imgAreaSelect.keyPress=$.browser.msie||$.browser.safari?"keydown":"keypress";if($.browser.opera){Q=e().css({width:"100%",height:"100%",position:"absolute",zIndex:A+2||2})}aq.add(X).css({visibility:"hidden",position:ac,overflow:"hidden",zIndex:A||"0"});aq.css({zIndex:A+2||2});ae.add(G).css({position:"absolute"});p.complete||p.readyState=="complete"||!av.is("img")?at():av.one("load",at)};$.fn.imgAreaSelect=function(f){f=f||{};this.each(function(){if($(this).data("imgAreaSelect")){$(this).data("imgAreaSelect").setOptions(f);if(f.close){}}else{if(f.enable===undefined&&f.disable===undefined){f.enable=true}$(this).data("imgAreaSelect",new $.imgAreaSelect(this,f))}});if(f.instance){return $(this).data("imgAreaSelect")}return this}});kola("newt.avatar.SimpleWindow",["jquery.Core","newt.util.StrUtil","newt.util.Browser","kola.lang.Class","newt.lib.drag"],function(c,e,d,b){var a=b.create({_init:function(f){this.isShowMask=!!(f.showOverLay||f.showMask);this.winEl=this.getWindowEl(f);this.name=f.name;this.mask=null;this.eventMap={};this.showContent=null;this.eventScope=f.eventHandlerScope;this.renderTitle(f);this.renderBody(f);this.renderFooter(f);this.bindEvents(f);this.fireCallback("onRender")},getWindowEl:function(f){if(!this.winEl){if(document.documentMode&&document.documentMode==8){f.position="fixed"}this.winEl=c(e.simpleFormat(this.WINDOW_TEMP,f))}return this.winEl},renderTitle:function(f){},renderBody:function(m){var f=c(this.winEl).find(".mwBd");var h=m.contents;var l,n,o,g,j,k;for(l=0,n=h.length;l<n;l++){o=h[l];g=o.name;j=c(o.dom);j.attr("data-content-name",g).addClass("nodis").appendTo(f);if(o.isShow){k=j}}c(k).removeClass("nodis")},renderFooter:function(o){var j=c(this.winEl).find(".mwFt");var l=o.btns,h=this.eventMap;var m,p,g,f,k,q,n=('<a href="javascript:void(0)" class="btn #{btnClass}"><b>#{text}</b></a>');for(m=0,p=l.length;m<p;m++){g=l[m];f=g.name;k=c(e.simpleFormat(n,g));c(k).attr("data-btn-name",f).addClass(g.isShow?"":"nodis").appendTo(j);if(g.onClick){h["btn:"+f]=g.onClick}}},bindEvents:function(f){var g=this;(function(){var k,h,l,m,j=["onRender","onBeforeOpen","onOpen","onBeforeClose","onClose","onBeforeShow","onShow","onBeforeHide","onHide","onContentSwitch"];for(k=0,h=j.length;k<h;k++){m=j[k];l=f[m];if(m&&typeof l=="function"){g[m]=l}}})();c(this.winEl).find(".mwCt>.close").click(function(){g.close()});this.bindDragEvent(f);this.bindBtnEvent(f)},bindDragEvent:function(k){var i=this.winEl;var n=c(i).find(".mwHd");var g,o,j,m,f,h,l=this;c(n).mousedown(function(s){var r=i[0].getBoundingClientRect();var q=l.getClientSize();var p=s.clientX;var t=s.clientY;h=q.width;f=q.height;g=p-r.left;j=r.right-p;o=t-r.top;m=r.bottom-t}).drag(function(s,q){var p=s.clientX,u=s.clientY;var t=((p<g)?0:(h-p)<j?(h-j-g):(p-g));var r=((u<o)?0:(f-u)<m?(f-m-o):(u-o));c(i).css({left:t+"px",top:r+"px"})})},bindBtnEvent:function(g){var i=this;var f=c(this.winEl).find(".mwFt");var h=function(){if(c(this).hasClass("btn_dis")){return false}var m=c(this).attr("data-btn-name");var k=i.eventMap["btn:"+m];var j=i.eventScope;if(k instanceof Function){try{k.call(j)}catch(l){}}};c(".btn",f[0]).live("click",h)},open:function(f){this.moveTo(f.left,f.top);this.fireCallback("onBeforeOpen");if(c(this.winEl).parent().length==0){if(document.documentMode&&document.documentMode==8){var g=c(this.winEl);c(g).appendTo("body").removeClass("nodis")}else{c(this.winEl).appendTo("#t-sky").removeClass("nodis")}if(this.isShowMask){this.renderMask(f)}}this.fireCallback("onOpen")},close:function(h,g){if(h!=false){var f=this.fireCallback("onBeforeClose");if(f==false){return}}if(this.mask){this.mask.remove()}if(g!=false){this.fireCallback("onClose")}c(this.winEl).remove()},hide:function(h,f){if(h!=false){var g=this.fireCallback("onBeforeHide");if(g==false){return}}var j=c(this.winEl);var i=j.css("left");j.attr("data-left",i);j.css("left","-500px");this.hideMask();if(f!=false){this.fireCallback("onHide")}},show:function(){this.fireCallback("onBeforeShow");var g=c(this.winEl);var f=g.attr("data-left");g.css("left",f+"px");this.showMask();this.fireCallback("onShow")},moveTo:function(){var k=this.getWindowEl();var m=[].slice.call(arguments);var g=this.getClientSize();var h,f,o,i,l,n,j;if(m.length==1){h=this.getDomPosi(m[0]);i=h.left;l=h.top}else{if(m.length==2){f=parseInt(m[0],10);o=parseInt(m[1],10);n=c(k).width()||100;j=c(k).height()||100;i=isNaN(f)?Math.floor((g.width-n)/2):f;l=isNaN(o)?Math.floor((g.height-j)/2):o}}c(k).css({left:i+"px",top:l+"px"})},getDomPosi:function(f){var j=f.el;var h=(d.isIE6?c("#t-sys")[0]:d.isWebKit?document.body:document.documentElement).scrollTop;var k=c(j)[0].getBoundingClientRect();var g=f.xOff||f.offsetLeft||0;var i=f.yOff||f.offsetTop||0;var m=Math.floor(h+k.top+i);var l=Math.floor(k.left+g);return{left:l,top:m}},getClientSize:function(){var f=document.compatMode=="CSS1Compat"?document.documentElement:document.body;return{width:f.clientWidth,height:f.clientHeight}},renderMask:function(g){var i=this.winEl;var h=parseInt(c(i).css("z-index"),10)-1;var f=(function(){if(document.all){var j=c(document).height(),k=c(window).height();return[window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,j-k<20?k:j]}return[c(window).width(),c(document).height()]})();this.mask=c(e.simpleFormat(this.MASK_TEMP,{zIndex:h,width:f[0],height:f[1],opacity:(g.opacity||"0.7"),backgroundColor:(g.overlayColor||g.maskColor||"#000")})).appendTo("#t-sky")},showMask:function(){var f=this.mask;if(!f){return}this.mask.removeClass("nodis")},hideMask:function(){var f=this.mask;if(!f){return}this.mask.addClass("nodis")},switchContent:function(g){var k=c(this.getWindowEl());var f=k.find("[data-content-name]");var h,n,p,m,o,j,l;for(h=0,n=f.length;h<n;h++){p=f[h];j=c(p).attr("data-content-name");if(p.offsetWidth>0){l=j;m=p}if(j==g){o=p}}if(o){c(m).addClass("nodis");c(o).removeClass("nodis");this.showContent=c(o);this.fireCallback("onContentSwitch",l,g)}},getContentEl:function(f){if(!f){return this.showContent}var g=c(this.getWindowEl());return g.find('[data-content-name="'+f+'"]')},getButtonEl:function(g){var f=this.getWindowEl();return c('.mwFt [data-btn-name="'+g+'"]',f)},setBtnShowState:function(f,h){var g=f?"removeClass":"addClass";var h=(typeof h=="string"?h.match(/\w+/g):h instanceof Array?h:[].slice.call(arguments,1));this.operateBtns(h,g,"nodis")},setBtnEnableState:function(g,h){var f=g?"removeClass":"addClass";var h=(typeof h=="string"?h.match(/\w+/g):h instanceof Array?h:[].slice.call(arguments,1));this.operateBtns(h,f,"btn_dis")},operateBtns:function(i,f,h){var g=c(".mwFt .btn",this.getWindowEl());g.each(function(){var j=c(this).data("btn-name");if(c.inArray(j,i)!=-1){c(this)[f](h)}})},fireCallback:function(g){var j=this[g];var h=this.eventScope;var f;if(j instanceof Function){try{f=[].slice.call(arguments,1);return j.apply(h,f)}catch(i){if(window.console&&console.log){console.log(i)}}}},WINDOW_TEMP:('<div id="#{name}" class="mw mwCA #{winClass} nodis" style="position:#{position};"><div class="mwCt"><a data-mt="btn-close" title="关闭" class="close" href="javascript:void(0)"></a><div class="mwHd"><h4></h4></div><div class="mwBd"></div><div class="mwFt"></div></div></div>'),MASK_TEMP:('<div data-mt="win-mask" style="position: absolute; top: 0px; left: 0px; width: #{width}px; height: #{height}px; display: block; opacity: #{opacity}; filter :alpha(opacity=70)\9;z-index: #{zIndex}; background-color: #{backgroundColor}; visibility: visible; "></div>')});return a});kola("newt.avatar.Upload",["jquery.Core","newt.widget.CutTheImage"],function(b,c){function a(f){var d=this;var e=d;b.extend(d,f);this.cutTheImage=new c({target:b(d.target),defaultImage:window.UID_ICON,viewTitle:"<h4><em>你现在的头像</em></h4>",uploadTip:"<h4><em>上传头像</em> <b>(支持jpg、png、gif、bmp格式的图片)</b></h4>",opTip:"<p class='ttl'>裁切头像图片</p>",hasSaveBtn:true,opFun:function(h){var g=this;var i=g.target.find("div.js-preview2 img").width();var j=g.target.find("div.js-preview2 img").height();var k=(typeof PHOTOICON=="string")?PHOTOICON.replace(/.*\//gi,""):"avt_180.png";b.ajax({url:"/pic/proxy",global:false,type:"post",dataType:"json",data:"act=icon&serviceid=31&uid="+window.UID+"&name="+escape(g.icon_path)+"&left="+parseInt(g.icon.left*g.img_w/i)+"&top="+parseInt(g.icon.top*g.img_h/j)+"&width="+parseInt(g.icon.width*g.img_w/i)+"&height="+parseInt(g.icon.height*g.img_h/j)+"&op="+k,success:function(m){h.success(m);var l=m;if(m){if(m.status==0){var n="act=save_icon&icon="+m.data;b.ajax({url:"/settings/icon/updateIcon",global:false,type:"post",dataType:"json",data:n,success:function(o){if(o){if(o.status==0){g.target.find("div.js-preview2").addClass("nodis");g.target.find("div.js-upavt-container").addClass("nodis");g.target.find("p.js-apb-container").addClass("nodis");g.target.find("a.js-save-icon").getCrControl("crButton").setEnable();g.target.find("a.js-save-icon").html("<b>保 存</b>");if(g.imgAreaSelect){g.imgAreaSelect.cancelSelection()}kola("newt.data.Synchronizer",function(p){p.save("new_avatar",l.data)});common.showTip("保存成功！");if(e.opCallback){e.opCallback()}}else{tw.notice.alert(o.statusText)}}else{tw.notice.alert("设置失败, 请稍后重试!")}},error:function(o){tw.notice.alert("设置失败, 请稍后重试!")}})}else{tw.notice.alert(m.statusText)}}else{tw.notice.alert("设置失败, 请稍后重试!")}},error:function(l){tw.notice.alert("设置失败, 请稍后重试!");h.error(l)}})}})}return a});