kola("util.validator.Core",["newt.widget.plus.Form","newt.data.Rule","jquery.Core","newt.net.NetCommon"],function(h,b,g,f){var a={VALIDATE_RULES:"validate_rules",LOCAL_PASS:"localpass",PARSER:"parser",SKIP_VALIDATE:"_skip_validate"};var k={VALIDATE:"validate",VALIDATE_SUCCESS:"validateSuccess",BEFORE_SUBMIT:"validateBeforeSubmit"};var i={REPLACE_VALUENAME:/\{(.*?)\}/g,REPLACE_GETTER:/\{\=.*?\}/g,FIND_CLASS_SETTING:/\bvalidate-[\w-]+\b/g};var d=0;function c(o){var n=this;n.remoteResults={};o.form=g(o.form);this.form=new h({form:o.form});if(o.rules){for(var r in o.rules){this.set(r,o.rules[r])}}if(o.validateListener){g(o.form).bind(k.VALIDATE,o.validateListener)}if(o.beforeSubmit){g(o.form).bind(k.BEFORE_SUBMIT,o.beforeSubmit)}this.remoteListenerIID=null;if(o.validateTriggers){o.validateTriggers=o.validateTriggers.split("|");for(var q=0,m=o.validateTriggers.length;q<m;++q){var p=false;if(o.validateTriggers[q].charAt(0)=="@"){p=true;o.validateTriggers[q]=o.validateTriggers[q].substr(1)}switch(o.validateTriggers[q]){case"submit":o.form.bind("submit",function(u){if(n.remoteListenerIID){clearInterval(n.remoteListenerIID)}if(o.form.data(a.SKIP_VALIDATE)){g(n.form.getDOM()).trigger(k.BEFORE_SUBMIT);return}var t=true;var s=n.getFormValidateResult({callback:function(y,w){if(t==false){return}for(var x in w){if(x=="VID"){continue}for(var z in w[x]){t=w[x][z]}}}});for(var l in s){if(l=="VID"){continue}if(t==false){break}for(var v in s[l]){t=s[l][v];if(t==false){break}}}g(n.form.getDOM()).trigger(k.VALIDATE,[s,false,u.type]);n.remoteListenerIID=setInterval(function(){if(t&&d<=0){clearInterval(n.remoteListenerIID);if(n.remoteResults[s.VID]!=false){if(o.formPassValidate){if(o.formPassValidate(function(){o.form.data(a.SKIP_VALIDATE,true).submit()})){}}else{o.form.data(a.SKIP_VALIDATE,true).submit()}}}},200);return false});break;default:if(p){o.form.bind(o.validateTriggers[q],function(l){n.validateForm(null,l.type)})}else{g(n.form.toElements()).filter("input[type='text'], input[type='password']").bind(o.validateTriggers[q],function(l){n.validate(this.name,{eventType:l.type})})}}}}this.settingByClass()}c.prototype.validateForm=function(l,m){g(this.form.getDOM()).trigger(k.VALIDATE,[this.getFormValidateResult(l),undefined,m])};c.prototype.getFormValidateResult=function(p){var s=this.form.toElements();var r={};p=p||{};g.extend(p,{_VID:++e});for(var q=0,n=s.length;q<n;++q){var m=this.getValidateResults(s[q].name,p);for(var o in m){r[o]=m[o]}}return r};c.prototype.localPass=function(l){return this.form.find("[name='"+l+"']:first").data(a.LOCAL_PASS)?true:false};c.prototype.validate=function(m,l){g(this.form.getDOM()).trigger(k.VALIDATE,[this.getValidateResults(m,l),false,(l&&l.eventType)?l.eventType:null])};function j(m,l){return(l.priority?l.priority:0)-(m.priority?m.priority:0)}var e=0;c.prototype.getValidateResults=function(o,B){B=B||{};var C=B.hasOwnProperty("_VID")?B._VID:++e;var u=this.form.find("[name='"+o+"']:first");if(!u||u.size()<=0){return null}var v={VID:C};var A=u.data(a.VALIDATE_RULES);var z=false;var p=[];if(A){var r=[];for(var y in A){var t={ruleName:y};g.extend(t,A[y]);r.push(t)}r.sort(j);var m=B?B.ruleName:null;var x=B?B.eventType:null;for(var s=0,q=r.length;s<q;++s){if(m){if(r[s].ruleName!=m){continue}}if(x){if(u.data("skip_"+x+"_"+r[s].ruleName)){continue}}if(r[s].enabled==true){var w=u.val();var n=u.data(a.PARSER)||r[s].parser;if(n&&n[r[s].ruleName]){w=n[r[s].ruleName](w)}if(v[o]==undefined){v[o]={}}if(r[s].ruleName=="remote"){r[s].name=o;r[s].success=B?B.callback:null;p.push(r[s]);continue}v[o][r[s].ruleName]=b.test(r[s].ruleName,w,r[s].options);if(v[o][r[s].ruleName]==false){z=true}}}}u.data(a.LOCAL_PASS,!z);if(!z){for(var s=0,q=p.length;s<q;++s){g.extend(p[s],{vid:C});this.remote(p[s])}}else{}return v};c.prototype.remote=function(x){var w=this;var r=this.form.find("[name='"+x.name+"']:first");var v=r.val();if(x.paramCreator){r.data(a.PARSER,{remote:x.paramCreator})}var m=r.data(a.PARSER);if(m&&m.remote){v=m.remote(v)}var q=x.params;var n=q.match(i.REPLACE_GETTER);if(n){for(var s=0,p=n.length;s<p;++s){q=q.replace(new RegExp(n[s].replace(/\{/g,"\\{").replace(/\}/g,"\\}").replace(/\=/g,"\\="),"g"),x.getters[g.trim(n[s].split("=")[1].split("}")[0])]())}}q=q.replace(i.REPLACE_VALUENAME,"$1="+v);var u=x.success;var t=x.beforeSend;var o=x.complete;g.extend(x,{data:q,type:x.type?x.type:"post",dataType:x.dataType?x.dataType:"json",success:function(y){var l={VID:x.vid};l[x.name]={};l[x.name]["remote"]=x.test(y);if(w.remoteResults[x.vid]!=false){w.remoteResults[x.vid]=l[x.name]["remote"]}g(w.form.getDOM()).trigger(k.VALIDATE,[l,true]);if(u){u(y,l)}},beforeSend:function(){++d;if(t){t.apply(this,arguments)}},complete:function(){--d;if(o){o.apply(this,arguments)}},noIntercept:false});f.request(x)};c.prototype.cleanRemoteCache=function(l){f.cleanCache(l)};c.prototype.set=function(n,y){var u=this.form.find("[name='"+n+"']:first");var z=this;if(u&&u.size()>0){var t=u.data(a.VALIDATE_RULES);if(!t){t={};u.data(a.VALIDATE_RULES,t)}for(var x in y){var w=y[x];if(w.triggers){if(t[x]&&t[x].triggers){var o=u.data("spe_triggers");if(o){for(var r in o){u.unbind(r,o[r])}u.removeData("spe_triggers")}var v=u.data("skip_eventkeys");if(v){for(var s=0,q=v.length;s<q;++s){u.removeData(v[s])}u.removeData("skip_eventkeys")}}var p=w.triggers.split("|");for(var s=0,q=p.length;s<q;++s){if(p[s].charAt(0)=="!"){var m="skip_"+p[s].substr(1)+"_"+x;u.data(m,true);var v=u.data("skip_eventkeys")||[];v.push(m);u.data("skip_eventkeys",v)}else{var o=u.data("spe_triggers")||{};o[p[s]]=function(l){z.validate(this.name,l.data)};u.bind(p[s],{ruleName:x},o[p[s]]);u.data("spe_triggers",o)}}}t[x]=y[x]}}};c.prototype.get=function(l,n){var m=this.form.find("[name='"+l+"']:first");var o=m.data(a.VALIDATE_RULES);return o?o[n]:null};c.prototype.settingByClass=function(){var m=this.form.toElements();for(var r=0,p=m.length;r<p;++r){var t=g(m[r]);var o=t.attr("class")||t.attr("className");if(o){var n=o.match(i.FIND_CLASS_SETTING);if(n){for(var q=0,s=n.length;q<s;++q){var u={};u[n[q].split("-").slice(1).join("-")]={enabled:true};this.set(t.attr("name"),u)}}}}};c.prototype.remoteAllDone=function(m){if(d==0){if(m){m()}}var l=setInterval(function(){if(d==0){clearInterval(l);if(m){m()}}},20)};return c});